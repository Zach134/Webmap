<!DOCTYPE html>
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Disputed Territories of India, Pakistan, and China</title>
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" type="text/css" crossorigin="">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.js" crossorigin=""></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
		<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.3/proj4.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.1/proj4leaflet.min.js"></script>
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-omnivore/0.3.4/leaflet-omnivore.js"></script> -->

        <script src ="selectedboundaries4326.js"></script>
		<script src ="disputedterritories.js"</script>
        <link rel="stylesheet" href="style.css" type="text/css">
       
        <script type="text/javascript">

	var map;

	function init() {
   		// create map and set center and zoom level
   		map = new L.map('mapid');
   		map.setView([34.0479, 76.7970], 5);
   		
		// create tile layer and add it to map
		var tiles = L.tileLayer('https://personal.psu.edu/zjn5071/termProjTiles/TPBasemap/{z}/{x}/{y}.png');
		tiles.addTo(map);

		/*// create wms layer
 		var selectedCountries = L.tileLayer.wms('http://localhost:8080/geoserver/termproject/wms', {
			layers: 'termproject:sc_projected',
			format: 'image/png',
			transparent: true
		}); 
		
		selectedCountries.addTo(map); */

		/*var redBoundariesLayer = omnivore.kml('redBoundarieskml.kml').on('ready', function() {
			map.fitBounds(runLayer.getBounds());            
    
			runLayer.eachLayer(function(layer) {            
				layer.bindPopup(layer.feature.properties.description);
				});
			}).addTo(map); */

		//redBoundariesLayer and disputedTerritotiesLayer are the two GeoJSONs that will be used for this lesson.
		var redBoundariesLayer;
		var disputedTerritoriesLayer;

		var selection;
		var selectedLayer;

		//styling for redBoundaries when it is not clicked
		function redBoundariesStyle(feature) {
			return {
				color: '#FF0000', 
				weight: 3, 
				opacity: 1, 
				dashArray: '8 4', 
				lineCap: 'round', 
				className: 'glowing-line'
			};
		}

		//styling for redBoundaries when it gets clicked
		function redBoundariesSelectedStyle(feature){
			return {
				color: '#008080', 
				weight: 2, 
				opacity: 1, 
				dashArray: '8 4', 
				lineCap: 'round', 
				className: 'glowing-line'
			};
		}

		// handle click events on disputed territories
		function redBoundariesOnEachFeature(feature, layer){
			layer.on({
				click: function(e) {
					if (selection) {            
						resetStyles();
					}
              
					e.target.setStyle(redBoundariesSelectedStyle);
					selection = e.target;
					selectedLayer = redBoundariesLayer;

					// Insert some HTML with the feature name
					buildSummaryLabel(feature);

					L.DomEvent.stopPropagation(e); // stop click event from being propagated further
				}
			});
		}

		// add the disputed red boundaries GeoJSON js file contents stored in redBoundariesGeoJSON variable
		redBoundariesLayer = new L.geoJSON(redBoundariesGeoJSON,{
			style: redBoundariesStyle,
			onEachFeature: redBoundariesOnEachFeature
		});
               
		redBoundariesLayer.addTo(map);

		// define the styles for the disputed boundaries (unselected and selected)
          function disputedTerritories(feature) {
            return {
               fillColor: "#FF00FF",
               fillOpacity: .4,
               color: '#B04173',
            };
        }
		  
		function DTSelectedStyle(feature) {
             return {
               fillColor: "#00FFFB",
               color: '#0000FF',
               fillOpacity: .4
            };
        }
		
		// handle click events on disputed territories
        function highlightDTOnEachFeature(feature, layer){
            layer.on({
				click: function(e) {
					if (selection) {            
						resetStyles();
					}
              
					e.target.setStyle(DTSelectedStyle);
					selection = e.target;
					selectedLayer = disputedTerritoriesLayer;

					// Insert some HTML with the feature name
					buildSummaryLabel(feature);

					L.DomEvent.stopPropagation(e); // stop click event from being propagated further
                }
            });
        }
		
		// add the disputedterritories GeoJSON layer using the DTGeoJSON variable from disputedterritories.js
        disputedTerritoriesLayer = new L.geoJSON(DTGeoJSON,{
            style: disputedTerritories,
			onEachFeature: highlightDTOnEachFeature
        });    
               
        disputedTerritoriesLayer.addTo(map);
		
		// handle clicks on the map that didn't hit a feature
		map.addEventListener('click', function(e) {
			if (selection) {
				resetStyles();
				selection = null;
				document.getElementById('summaryLabel').innerHTML = '<p>Click a red disputed boundary line or disputed territory for more information.</p>';
			}
		});

		function resetStyles(){
			if (selectedLayer === redBoundariesLayer || selectedLayer === disputedTerritoriesLayer){
				selectedLayer.resetStyle(selection);
			}
		}

		// function to build the HTML for the summary label using the selected feature's "BRK_NAME" property
		function buildSummaryLabel(currentFeature){
			var featureName = currentFeature.properties.BRK_NAME || "Unnamed feature";
			document.getElementById('summaryLabel').innerHTML = '<p style="font-size:18px"><b>' + featureName + '</b></p>';
		}
		
		/*
		function Identify(e)
		{
			// set parameters needed for GetFeatureInfo WMS request
			var sw = map.options.crs.project(map.getBounds().getSouthWest());
			var ne = map.options.crs.project(map.getBounds().getNorthEast());
			var BBOX = sw.x + "," + sw.y + "," + ne.x + "," + ne.y;
			var WIDTH = map.getSize().x;
			var HEIGHT = map.getSize().y;
		
			var X = Math.trunc(map.layerPointToContainerPoint(e.layerPoint).x);
			var Y = Math.trunc(map.layerPointToContainerPoint(e.layerPoint).y);
		
			// compose the URL for the request
			var URL = 'http://localhost:8080/geoserver/termproject/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&LAYERS=termproject:sc_projected&QUERY_LAYERS=termproject:sc_projected&BBOX='+BBOX+'&FEATURE_COUNT=1&HEIGHT='+HEIGHT+'&WIDTH='+WIDTH+'&INFO_FORMAT=application%2Fjson&TILED=false&CRS=EPSG%3A3857&I='+X+'&J='+Y;

			//send GetFeatureInfo as asynchronous HTTP request using jQuery $.ajax
			$.ajax({
    			url: URL,
    			dataType: "json",
    			type: "GET",
    			success: function(data)
    		         {
						if(data.features.length !== 0) {  // at least one feature returned in response
							var returnedFeature = data.features[0]; // first feature from response
            
							// Set up popup for clicked feature and open it. There's some additional added styling to the popup
							// window. I got inspired looking at the Bikeshare map.
							var popup = new L.Popup({
								className: 'custom-popup'
							});

						// Construct the popup content using HTML elements with classes
						var popupContent = "<h2>Information</h2>" + "<p><b>Territory Name:</b>" + returnedFeature.properties.BRK_NAME + "</p>" + "<p><b>Population Estimate:</b>" + returnedFeature.properties.POP_EST + "</p>" + "<p><b>COUNTRY NAME:</b>" + returnedFeature.properties.NAME + "</p>";

						// Set the modified content to the popup
						popup.setContent(popupContent);
						popup.setLatLng(e.latlng);
						map.openPopup(popup);
						}
					}
				});
			}		
			map.addEventListener('click', Identify); 
			*/
	}
	
                     
        </script>
      </head>
      <body onload="init()">
        <h1 id="title">Selected disputed territories for India, Pakistan, and China</h1>
    
        <div id="mapid">
        </div>
    
        <div id="docs">
            <p>This page shows information about disputed territories in India, Pakistan, and China. Click a region for more information.</p>
        </div>

      </body>
    </html>